package main;

import javax.swing.*;
import java.awt.event.*;
import java.io.*;
import java.nio.file.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class MyMenu extends JMenuBar {

    private Centralina centralina;

    public MyMenu(Centralina centralina) {
        this.centralina = centralina;

        // --- Menu File ---
        JMenu fileMenu = new JMenu("File");

        // Voce Esporta
        JMenuItem esportaItem = new JMenuItem("Esporta");
        esportaItem.addActionListener(e -> esportaSuFile());

        fileMenu.add(esportaItem);
        this.add(fileMenu);
    }

    private void esportaSuFile() {
        try {
            // Percorso desktop utente
            String desktopPath = System.getProperty("user.home") + "/Desktop";

            // Nome della cartella per l'esportazione
            String cartellaNome = "Casa_Intelligente_Esportazioni";
            File cartella = new File(desktopPath + "/" + cartellaNome);

            // Crea la cartella se non esiste
            if (!cartella.exists()) {
                boolean creata = cartella.mkdir();
                if (!creata) {
                    JOptionPane.showMessageDialog(null, "Errore nella creazione della cartella!",
                            "Errore", JOptionPane.ERROR_MESSAGE);
                    return;
                }
            }

            // Nome del file con giorno e ora leggibili
            String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd-MM-yyyy_HH-mm-ss"));
            File file = new File(cartella, "dati_" + timestamp + ".txt");

            // Scrive i dati nel file
            try (BufferedWriter writer = Files.newBufferedWriter(file.toPath())) {
                writer.write("=== ESPORTAZIONE CASA INTELLIGENTE ===\n");
                writer.write("Data esportazione: " + LocalDateTime.now().format(
                        DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")) + "\n\n");
                writer.write(centralina.getStato());
            }

            JOptionPane.showMessageDialog(null, "Dati esportati con successo in:\n" + file.getAbsolutePath(),
                    "Esporta completata", JOptionPane.INFORMATION_MESSAGE);

        } catch (IOException ex) {
            JOptionPane.showMessageDialog(null, "Errore durante l'esportazione: " + ex.getMessage(),
                    "Errore", JOptionPane.ERROR_MESSAGE);
            ex.printStackTrace();
        }
    }
}
